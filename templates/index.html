<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>הצבעה - דוד שמש בגג המשותף</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
            direction: rtl;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
        }
        input[type="number"],
        input[type="text"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            box-sizing: border-box;
        }
        .vote-options {
            display: flex;
            gap: 10px;
            margin: 20px 0;
        }
        .vote-button {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 5px;
            font-size: 18px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .vote-for {
            background-color: #4CAF50;
            color: white;
        }
        .vote-against {
            background-color: #f44336;
            color: white;
        }
        .vote-button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .results {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 5px;
        }
        .error-message {
            color: #f44336;
            margin-top: 10px;
            padding: 10px;
            background: #ffebee;
            border-radius: 5px;
            display: none;
        }
        .success-message {
            color: #4CAF50;
            margin-top: 10px;
            padding: 10px;
            background: #e8f5e9;
            border-radius: 5px;
            display: none;
        }
        .info-message {
            color: #1976d2;
            margin-top: 10px;
            padding: 10px;
            background: #e3f2fd;
            border-radius: 5px;
            text-align: center;
        }
        .poll-ended {
            background: #ffebee;
            color: #d32f2f;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: bold;
        }
        .countdown {
            text-align: center;
            margin: 20px 0;
            font-size: 1.1em;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>הצבעה: התקנת דוד שמש בגג המשותף</h1>

        <div id="pollEnded" class="poll-ended" style="display: none;">
            ההצבעה הסתיימה
        </div>

        <div id="pollActive" style="display: none;">
            <div class="countdown" id="countdown"></div>
            
            <div class="form-group">
                <label for="apartment">מספר דירה:</label>
                <input type="number" id="apartment" min="1" max="19" required>
            </div>

            <div class="form-group" id="nameGroup" style="display: none;">
                <label for="name">שם המצביע:</label>
                <input type="text" id="name" required>
            </div>

            <div class="vote-options" id="voteOptions" style="display: none;">
                <button class="vote-button vote-for" onclick="submitVote('בעד')">בעד</button>
                <button class="vote-button vote-against" onclick="submitVote('נגד')">נגד</button>
            </div>
        </div>

        <div class="error-message" id="errorMessage"></div>
        <div class="success-message" id="successMessage"></div>

        <div class="results">
            <h2>תוצאות ההצבעה</h2>
            <div id="resultsContent" style="display: none;">
                <p>בעד: <span id="forVotes">0</span></p>
                <p>נגד: <span id="againstVotes">0</span></p>
                <p>סה"כ הצביעו: <span id="totalVotes">0</span></p>
            </div>
            <div id="resultsMessage" class="info-message">
                התוצאות יפורסמו בסיום ההצבעה
            </div>
        </div>
    </div>

    <script>
        let canVote = false;
        const endDate = new Date("{{ .endDate }}");
        const apartmentInput = document.getElementById('apartment');
        const nameGroup = document.getElementById('nameGroup');
        const voteOptions = document.getElementById('voteOptions');
        const errorMessage = document.getElementById('errorMessage');
        const successMessage = document.getElementById('successMessage');
        const pollEnded = document.getElementById('pollEnded');
        const pollActive = document.getElementById('pollActive');
        const resultsContent = document.getElementById('resultsContent');
        const resultsMessage = document.getElementById('resultsMessage');
        const countdown = document.getElementById('countdown');

        function updateCountdown() {
            const now = new Date();
            const timeLeft = endDate - now;

            if (timeLeft <= 0) {
                pollEnded.style.display = 'block';
                pollActive.style.display = 'none';
                updateResults();
                return;
            }

            const days = Math.floor(timeLeft / (1000 * 60 * 60 * 24));
            const hours = Math.floor((timeLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));

            countdown.textContent = `זמן נותר להצבעה: ${days} ימים, ${hours} שעות, ${minutes} דקות`;
            pollEnded.style.display = 'none';
            pollActive.style.display = 'block';
        }

        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
            successMessage.style.display = 'none';
        }

        function showSuccess(message) {
            successMessage.textContent = message;
            successMessage.style.display = 'block';
            errorMessage.style.display = 'none';
        }

        function updateResults() {
            fetch('/api/results')
                .then(response => response.json())
                .then(data => {
                    if (data.hidden) {
                        resultsContent.style.display = 'none';
                        resultsMessage.textContent = data.message;
                        resultsMessage.style.display = 'block';
                    } else {
                        resultsContent.style.display = 'block';
                        resultsMessage.style.display = 'none';
                        document.getElementById('forVotes').textContent = data.for;
                        document.getElementById('againstVotes').textContent = data.against;
                        document.getElementById('totalVotes').textContent = data.total;
                    }
                })
                .catch(error => console.error('Error fetching results:', error));
        }

        apartmentInput.addEventListener('change', function() {
            const apartmentNumber = this.value;
            if (!apartmentNumber) return;

            if (apartmentNumber < 1 || apartmentNumber > 19) {
                showError('מספר דירה לא תקין');
                nameGroup.style.display = 'none';
                voteOptions.style.display = 'none';
                return;
            }

            fetch(`/api/check-apartment/${apartmentNumber}`)
                .then(response => response.json())
                .then(data => {
                    if (data.voted) {
                        showError(`דירה זו כבר הצביעה (${data.name})`);
                        nameGroup.style.display = 'none';
                        voteOptions.style.display = 'none';
                        canVote = false;
                    } else {
                        errorMessage.style.display = 'none';
                        nameGroup.style.display = 'block';
                        voteOptions.style.display = 'block';
                        canVote = true;
                    }
                })
                .catch(error => {
                    console.error('Error checking apartment:', error);
                    showError('אירעה שגיאה בבדיקת הדירה');
                });
        });

        function submitVote(vote) {
            if (!canVote) return;

            const apartmentNumber = document.getElementById('apartment').value;
            const voterName = document.getElementById('name').value;

            if (!apartmentNumber || !voterName) {
                showError('נא למלא את כל השדות');
                return;
            }

            fetch('/api/vote', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    apartment_number: parseInt(apartmentNumber),
                    voter_name: voterName,
                    vote: vote
                })
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => { throw new Error(err.error) });
                }
                return response.json();
            })
            .then(data => {
                showSuccess('ההצבעה נקלטה בהצלחה');
                nameGroup.style.display = 'none';
                voteOptions.style.display = 'none';
                canVote = false;
            })
            .catch(error => {
                showError(error.message || 'אירעה שגיאה בשליחת ההצבעה');
            });
        }

        // Update countdown every minute
        updateCountdown();
        setInterval(updateCountdown, 60000);

        // Check if poll has ended and update UI accordingly
        if (new Date() > endDate) {
            pollEnded.style.display = 'block';
            pollActive.style.display = 'none';
            updateResults();
        } else {
            updateResults();
        }
    </script>
</body>
</html> 